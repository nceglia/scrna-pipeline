#!/usr/bin/env python3
import click
import os
import subprocess

@click.command()
@click.option('--project', prompt='Project name.', help='Project name for pipeline run.')
@click.option('--mito', prompt='Percent reads mitochondrial threshold.', help='Maximum percent reads mitochondrial')
@click.option('--doublet', prompt='Scrublet score threshold.', help='Maximum scrublet score')
@click.option('--image', prompt='docker or singularity image.', help='Image name (nceglia/scrna-pipeline:latest, scrna-pipeline.img, etc...)')
@click.option('--runtime', prompt='docker or singularity.', help='Whether to run sub tasks with docker or singularity command.')
@click.option('--gmt', prompt='GMT file for pathway analysis.', help='GMT used for pathway enrichment.')
@click.option('--yaml', prompt='YAML cell type markers.', help='YAML file with cell type and gene markers (see resources/markers.yaml)')
@click.option('--jobs', prompt='Max jobs.', help='Number of parallel jobs.')
@click.option('--mode', prompt='Job mode (local, lsf, sge, etc.)', help='Job mode provided to martian.')
@click.option('--subtypes', prompt='Subtype CSV', help='Subtype CSV')
@click.option('--subtypes', prompt='Subtype CSV', help='Subtype CSV')

def rnascp(project, mito, doublet, image, runtime, gmt, yaml, jobs, mode, subtypes):
    click.clear()

    click.echo(click.style('******** SCRNA-PIPELINE ********', fg='green'))
    click.echo(click.style('Building Config...', fg='blue'))
    click.echo(click.style("Project Name: ", fg='green', bold=True),nl=False)
    click.echo(click.style(project, fg='red', bold=True))
    click.echo(click.style("Image: ", fg='green', bold=True),nl=False)
    click.echo(click.style(image, fg='red', bold=True))
    click.echo(click.style("Runtime: ", fg='green', bold=True),nl=False)
    click.echo(click.style(runtime, fg='red', bold=True))
    click.echo(click.style("Parallel Jobs: ", fg='green', bold=True),nl=False)
    click.echo(click.style(jobs, fg='red', bold=True))
    click.echo(click.style("Job Mode: ", fg='green', bold=True),nl=False)
    click.echo(click.style(mode, fg='red', bold=True))

    output = open("__{}.mro".format(project),"w")
    output.write('@include "pipeline.mro"\n\n')
    output.write('call RNASCP(\n')
    output.write('\tproject = "{}",\n'.format(project))
    output.write('\tmito = {},\n'.format(mito))
    output.write('\tscore = {},\n'.format(doublet))
    output.write('\timage = "{}",\n'.format(image))
    output.write('\truntime = "{}",\n'.format(runtime))
    output.write('\tgmt = "{}",\n'.format(gmt))
    output.write('\tyaml = "{}",\n'.format(yaml))
    output.write('\tsubtypes = "{}",\n'.format(subtypes))
    output.write(')\n')
    cmd = "mrp __{0}.mro {0} --jobmode={1} --maxjobs={2}".format(project, mode, jobs)
    print(cmd)
    #subprocess.call(cmd.split())

if __name__ == '__main__':
    rnascp()